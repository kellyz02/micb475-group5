library(tidyverse)
library(phyloseq)
library(indicspecies)

load("phyloseq_file.RData")

# Subset for Tub in climate B

phylo_tub<- subset_samples(phyloseq_file, Taxonomy_Order == "Tubulidentata")
phylo_tub_climate <- subset_samples(phylo_tub, Climate..basic. == "B")

#### Indicator Species/Taxa Analysis ####
phyloseq_tub_order_glom <- tax_glom(phylo_tub_climate, "Genus", NArm = FALSE) 
phyloseq_order_tub_RA<- transform_sample_counts(phyloseq_tub_order_glom, fun=function(x) x/sum(x))

#ISA
isa_tub_phylo <- multipatt(t(otu_table(phyloseq_order_tub_RA)), cluster = sample_data(phyloseq_order_tub_RA)$`captive_wild`)
summary(isa_tub_phylo)
taxtable <- tax_table(phyloseq_file) %>% as.data.frame() %>% rownames_to_column(var="ASV")

isa_tub_phylo$sign %>%
  rownames_to_column(var="ASV") %>%
  left_join(taxtable) %>%
  filter(p.value<0.05) %>% View() 

#Subset for Primate in Climate C

phylo_primate<- subset_samples(phyloseq_file, Taxonomy_Order == "Primates")
phylo_primate_climate <- subset_samples(phylo_primate, Climate..basic. == "C")

#### Indicator Species/Taxa Analysis ####
phyloseq_primate_order_glom <- tax_glom(phylo_primate_climate, "Genus", NArm = FALSE) 
phyloseq_order_primate_RA<- transform_sample_counts(phyloseq_primate_order_glom, fun=function(x) x/sum(x))

#ISA
isa_primate_phylo <- multipatt(t(otu_table(phyloseq_order_primate_RA)), cluster = sample_data(phyloseq_order_primate_RA)$`captive_wild`)
summary(isa_primate_phylo)
taxtable <- tax_table(phyloseq_file) %>% as.data.frame() %>% rownames_to_column(var="ASV")

isa_primate_phylo$sign %>%
  rownames_to_column(var="ASV") %>%
  left_join(taxtable) %>%
  filter(p.value<0.05) %>% View()
